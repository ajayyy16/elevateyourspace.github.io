<?php
// Start a secure session
session_start([
    'cookie_secure' => true,     // Ensure cookies are sent only over HTTPS
    'cookie_httponly' => true,     // Prevent JavaScript access to session cookies
    'use_strict_mode' => true      // Prevent session fixation attacks
]);

// Database connection
$conn = new mysqli('localhost', 'root', '', 'furniture_store');
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

// Get order details from session (set in payment.php)
$order_id = $_SESSION['order_id'] ?? null;
$total_amount = $_SESSION['total_amount'] ?? null;

// Validate session data
if (empty($order_id) || empty($total_amount)) {
    die("Error: Invalid session data. Please ensure you're accessing this page correctly.");
}

// Get payment method from form submission
$payment_method = $_POST['payment_method'] ?? null;
if (empty($payment_method)) {
    die("Error: Payment method is required.");
}

// Get payment details from form submission
$card_number = $_POST['card_number'] ?? null;
$expiry_month = $_POST['expiry_month'] ?? null;
$expiry_year = $_POST['expiry_year'] ?? null;
$cvv = $_POST['cvv'] ?? null;
$upi_id = $_POST['upi_id'] ?? null;

// Sanitize inputs
$order_id = filter_var($order_id, FILTER_SANITIZE_STRING);
$total_amount = filter_var($total_amount, FILTER_SANITIZE_NUMBER_FLOAT, FILTER_FLAG_ALLOW_FRACTION);
$payment_method = filter_var($payment_method, FILTER_SANITIZE_STRING);
$card_number = !empty($card_number) ? filter_var($card_number, FILTER_SANITIZE_STRING) : null;
$expiry_month = !empty($expiry_month) ? filter_var($expiry_month, FILTER_SANITIZE_STRING) : null;
$expiry_year = !empty($expiry_year) ? filter_var($expiry_year, FILTER_SANITIZE_STRING) : null;
$cvv = !empty($cvv) ? filter_var($cvv, FILTER_SANITIZE_STRING) : null;
$upi_id = !empty($upi_id) ? htmlspecialchars($upi_id) : null;

// Prepare SQL query to insert payment details securely
$stmt = $conn->prepare("INSERT INTO payment_details (order_id, total_amount, payment_method, card_number, expiry_month, expiry_year, cvv, upi_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?)");
if (!$stmt) {
    die("Error preparing SQL statement: " . $conn->error);
}
$stmt->bind_param("sdssssss", $order_id, $total_amount, $payment_method, $card_number, $expiry_month, $expiry_year, $cvv, $upi_id);

if ($stmt->execute()) {
    // Update order status to "Paid"
    $updateOrderStmt = $conn->prepare("UPDATE orders SET status='Paid' WHERE order_id=?");
    if (!$updateOrderStmt) {
        die("Error preparing update statement: " . $conn->error);
    }
    $updateOrderStmt->bind_param("s", $order_id);
    if (!$updateOrderStmt->execute()) {
        die("Error executing update statement: " . $updateOrderStmt->error);
    }
    
    // Redirect to success page with total amount
    header("Location: success.php?total=" . urlencode($total_amount));
    exit();
} else {
    // Log the error and redirect to a failure page
    error_log("Database error: " . $stmt->error);
    header("Location: failure.html");
    exit();
}

// Close statements and connection (unreachable here but good practice if code structure changes)
$stmt->close();
if (isset($updateOrderStmt)) {
    $updateOrderStmt->close();
}
$conn->close();
?>
